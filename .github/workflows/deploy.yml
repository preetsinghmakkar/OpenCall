name: Deploy OpenCall Backend to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build Linux binary
        run: |
          mkdir -p build
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o build/opencall ./cmd/server

      - name: Pre-stop service and remove old binary on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_TARGET_DIR,BINARY_NAME
        env:
          EC2_TARGET_DIR: ${{ secrets.EC2_TARGET_DIR }}
          BINARY_NAME: opencall
        script: |
          set -e
          echo "Stopping service and cleaning up old binary"
          sudo mkdir -p "${EC2_TARGET_DIR}"
          if command -v systemctl >/dev/null 2>&1; then
            sudo systemctl stop opencall.service || true
          else
            pkill -f "${EC2_TARGET_DIR}/${BINARY_NAME}" || true
          fi
          sudo rm -f "${EC2_TARGET_DIR}/${BINARY_NAME}" || true

      - name: Copy new binary to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: build/opencall
          target: ${{ secrets.EC2_TARGET_DIR }}
          overwrite: true

      - name: Start service on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_TARGET_DIR,BINARY_NAME
        env:
          EC2_TARGET_DIR: ${{ secrets.EC2_TARGET_DIR }}
          BINARY_NAME: opencall
        script: |
          set -e
          echo "Starting service"
          sudo chmod +x "${EC2_TARGET_DIR}/${BINARY_NAME}"
          if command -v systemctl >/dev/null 2>&1 && [ -f "/etc/systemd/system/opencall.service" ]; then
            sudo systemctl daemon-reload || true
            sudo systemctl start opencall.service
            sudo systemctl status opencall.service --no-pager --lines=0 || true
          else
            nohup "${EC2_TARGET_DIR}/${BINARY_NAME}" > "${EC2_TARGET_DIR}/${BINARY_NAME}.out" 2>&1 &
          fi
